<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>EchoVoid</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’¬</text></svg>">
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /*  ECHOVOID â€” NEW DESIGN                         */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * { margin:0; padding:0; box-sizing:border-box; }

    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a28;
      --bg-hover: #22223a;
      --bg-active: #2a2a45;
      --bg-card: #16162a;
      --bg-input: #1e1e30;
      --bg-modal: rgba(0,0,0,0.85);

      --text-primary: #f0f0f5;
      --text-secondary: #a0a0b8;
      --text-muted: #6b6b80;
      --text-ghost: #4a4a5e;

      --accent: #7c3aed;
      --accent-hover: #6d28d9;
      --accent-glow: rgba(124,58,237,0.3);
      --accent-light: #a78bfa;

      --green: #22c55e;
      --green-glow: rgba(34,197,94,0.2);
      --red: #ef4444;
      --red-hover: #dc2626;
      --orange: #f59e0b;
      --blue: #3b82f6;

      --border: #2a2a3d;
      --border-light: #3a3a50;

      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-full: 9999px;

      --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
      --shadow-glow: 0 0 20px var(--accent-glow);

      --transition: all 0.2s ease;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /*  SCROLLBAR                                     */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /*  AUTH SCREEN                                   */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #auth-screen {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    #auth-screen.hidden { display: none; }

    .auth-container {
      width: 380px;
      max-width: 90vw;
      text-align: center;
    }

    .auth-logo {
      margin-bottom: 40px;
    }
    .auth-logo h1 {
      font-size: 36px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-light), var(--accent), #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      letter-spacing: -1px;
    }
    .auth-logo p {
      color: var(--text-muted);
      font-size: 14px;
    }

    .auth-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 32px;
      box-shadow: var(--shadow-lg);
    }

    .auth-card h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-primary);
    }
    .auth-card .subtitle {
      color: var(--text-muted);
      font-size: 13px;
      margin-bottom: 24px;
    }

    .input-group {
      position: relative;
      margin-bottom: 16px;
    }
    .input-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-align: left;
    }
    .input-group input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 15px;
      font-family: inherit;
      outline: none;
      transition: var(--transition);
    }
    .input-group input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .input-group input::placeholder {
      color: var(--text-ghost);
    }

    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: white;
      box-shadow: var(--shadow-glow);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 30px var(--accent-glow);
    }
    .btn-primary:active { transform: translateY(0); }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .auth-footer {
      margin-top: 20px;
      font-size: 12px;
      color: var(--text-ghost);
    }

    #code-section { display: none; }
    #code-section.show { display: block; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /*  MAIN LAYOUT                                   */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #app {
      display: none;
      height: 100vh;
      width: 100vw;
    }
    #app.show { display: flex; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /*  SIDEBAR                                       */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #sidebar {
      width: 340px;
      min-width: 340px;
      height: 100vh;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-header h2 {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-light), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-actions {
      display: flex;
      gap: 4px;
    }
    .header-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    .header-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    .header-btn svg { width: 20px; height: 20px; }

    /* Search */
    .search-box {
      padding: 12px 20px;
    }
    .search-input-wrap {
      position: relative;
      display: flex;
      align-items: center;
    }
    .search-input-wrap svg {
      position: absolute;
      left: 12px;
      width: 16px;
      height: 16px;
      color: var(--text-ghost);
      pointer-events: none;
    }
    .search-input-wrap input {
      width: 100%;
      padding: 10px 12px 10px 36px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-full);
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: var(--transition);
    }
    .search-input-wrap input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .search-input-wrap input::placeholder { color: var(--text-ghost); }

    /* Tabs */
    .sidebar-tabs {
      display: flex;
      padding: 0 20px;
      gap: 4px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-tab {
      flex: 1;
      padding: 10px 0;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: var(--transition);
    }
    .sidebar-tab.active {
      color: var(--accent-light);
      border-bottom-color: var(--accent);
    }
    .sidebar-tab:hover:not(.active) {
      color: var(--text-secondary);
    }

    /* Contact List */
    .contact-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 12px;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }
    .contact-item:hover { background: var(--bg-hover); }
    .contact-item.active { background: var(--bg-active); }

    .contact-avatar {
      position: relative;
      flex-shrink: 0;
    }
    .contact-avatar img {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-full);
      object-fit: cover;
      background: var(--bg-tertiary);
    }
    .online-dot {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      background: var(--green);
      border: 2px solid var(--bg-secondary);
      border-radius: var(--radius-full);
      box-shadow: 0 0 6px var(--green-glow);
    }

    .contact-info {
      flex: 1;
      min-width: 0;
    }
    .contact-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .contact-last-msg {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }

    .contact-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      flex-shrink: 0;
    }
    .contact-time {
      font-size: 11px;
      color: var(--text-ghost);
    }
    .unread-badge {
      background: var(--accent);
      color: white;
      font-size: 11px;
      font-weight: 600;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .empty-state h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .empty-state p {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /*  CHAT AREA                                     */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      height: 100vh;
    }

    /* No Chat Selected */
    #no-chat {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 12px;
    }
    #no-chat.hidden { display: none; }
    #no-chat .logo-big {
      font-size: 64px;
      margin-bottom: 8px;
    }
    #no-chat h2 {
      font-size: 22px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    #no-chat p {
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Active Chat */
    #active-chat {
      display: none;
      flex-direction: column;
      height: 100vh;
    }
    #active-chat.show {
      display: flex;
    }

    /* Chat Header */
    .chat-header {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-secondary);
      min-height: 64px;
    }
    .chat-header-back {
      display: none;
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      align-items: center;
      justify-content: center;
    }
    .chat-header-avatar {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      object-fit: cover;
      cursor: pointer;
      transition: var(--transition);
      background: var(--bg-tertiary);
    }
    .chat-header-avatar:hover { opacity: 0.8; }
    .chat-header-info {
      flex: 1;
      cursor: pointer;
    }
    .chat-header-info h3 {
      font-size: 15px;
      font-weight: 600;
    }
    .chat-header-info span {
      font-size: 12px;
      color: var(--text-muted);
    }
    .chat-header-actions {
      display: flex;
      gap: 4px;
    }

    /* Messages */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .msg {
      max-width: 70%;
      display: flex;
      flex-direction: column;
      animation: msgIn 0.2s ease;
    }
    @keyframes msgIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg.out { align-self: flex-end; }
    .msg.in { align-self: flex-start; }

    .msg-bubble {
      padding: 10px 14px;
      border-radius: var(--radius-lg);
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
      position: relative;
    }
    .msg.out .msg-bubble {
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: white;
      border-bottom-right-radius: 4px;
    }
    .msg.in .msg-bubble {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
    }

    .msg-sender {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-light);
      margin-bottom: 2px;
    }

    .msg-time {
      font-size: 10px;
      color: rgba(255,255,255,0.5);
      text-align: right;
      margin-top: 4px;
    }
    .msg.in .msg-time { color: var(--text-ghost); }

    .msg-image {
      max-width: 280px;
      max-height: 300px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }
    .msg-image:hover { opacity: 0.9; }

    .msg-video {
      max-width: 320px;
      border-radius: var(--radius-md);
    }

    .msg-file {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.15);
      border-radius: var(--radius-sm);
      text-decoration: none;
      color: inherit;
    }
    .msg-file-icon { font-size: 28px; }
    .msg-file-name {
      font-size: 13px;
      font-weight: 500;
    }
    .msg-file-size {
      font-size: 11px;
      opacity: 0.6;
    }

    .voice-msg {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 200px;
    }
    .voice-play-btn {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .msg.in .voice-play-btn {
      background: var(--accent-glow);
      color: var(--accent-light);
    }
    .voice-wave {
      flex: 1;
      height: 30px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .voice-wave-bar {
      width: 3px;
      border-radius: 2px;
      background: rgba(255,255,255,0.4);
    }
    .msg.in .voice-wave-bar { background: var(--text-ghost); }

    /* Date separator */
    .date-sep {
      text-align: center;
      padding: 12px;
    }
    .date-sep span {
      font-size: 12px;
      color: var(--text-ghost);
      background: var(--bg-secondary);
      padding: 4px 14px;
      border-radius: var(--radius-full);
    }

    /* Typing indicator */
    .typing-indicator {
      padding: 4px 20px;
      font-size: 12px;
      color: var(--accent-light);
      height: 24px;
      font-style: italic;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /*  INPUT BAR                                     */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .input-bar {
      padding: 12px 20px;
      display: flex;
      align-items: flex-end;
      gap: 10px;
      border-top: 1px solid var(--border);
      background: var(--bg-secondary);
    }

    .input-actions {
      display: flex;
      gap: 2px;
      padding-bottom: 4px;
    }
    .input-action-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    .input-action-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    .input-action-btn svg { width: 20px; height: 20px; }

    .input-text-wrap {
      flex: 1;
      position: relative;
    }
    #msg-input {
      width: 100%;
      max-height: 120px;
      padding: 10px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      outline: none;
      transition: var(--transition);
      line-height: 1.4;
    }
    #msg-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    #msg-input::placeholder { color: var(--text-ghost); }

    .send-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: white;
      border-radius: var(--radius-full);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      flex-shrink: 0;
      margin-bottom: 2px;
      box-shadow: var(--shadow-glow);
    }
    .send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px var(--accent-glow);
    }
    .send-btn svg { width: 18px; height: 18px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /*  MODALS                                        */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-modal);
      z-index: 5000;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
      animation: fadeIn 0.2s ease;
    }
    .modal-overlay.hidden { display: none; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 24px;
      width: 400px;
      max-width: 90vw;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .modal-header h3 {
      font-size: 18px;
      font-weight: 600;
    }
    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-hover);
      color: var(--text-secondary);
      border-radius: var(--radius-full);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    .modal-close:hover {
      background: var(--red);
      color: white;
    }

    /* Profile Modal */
    .profile-avatar-wrap {
      text-align: center;
      margin-bottom: 20px;
    }
    .profile-avatar {
      width: 96px;
      height: 96px;
      border-radius: var(--radius-full);
      object-fit: cover;
      border: 3px solid var(--accent);
      box-shadow: 0 0 20px var(--accent-glow);
      background: var(--bg-tertiary);
    }
    .profile-name {
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 4px;
    }
    .profile-handle {
      font-size: 14px;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 12px;
    }
    .profile-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 13px;
      margin-bottom: 16px;
    }
    .profile-status.online { color: var(--green); }
    .profile-status.offline { color: var(--text-muted); }
    .profile-status-dot {
      width: 8px;
      height: 8px;
      border-radius: var(--radius-full);
    }
    .profile-status.online .profile-status-dot { background: var(--green); box-shadow: 0 0 6px var(--green-glow); }
    .profile-status.offline .profile-status-dot { background: var(--text-ghost); }

    .profile-bio {
      background: var(--bg-tertiary);
      padding: 12px;
      border-radius: var(--radius-md);
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 16px;
      text-align: center;
    }

    .profile-section {
      margin-top: 16px;
    }
    .profile-section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    .avatar-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .avatar-grid-item {
      aspect-ratio: 1;
      border-radius: var(--radius-sm);
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: var(--transition);
    }
    .avatar-grid-item.current { border-color: var(--accent); }
    .avatar-grid-item:hover { border-color: var(--border-light); }
    .avatar-grid-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Settings Modal */
    .settings-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }
    .settings-item:hover { background: var(--bg-hover); }
    .settings-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      background: var(--bg-tertiary);
    }
    .settings-info h4 {
      font-size: 14px;
      font-weight: 500;
    }
    .settings-info p {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Image Viewer */
    #img-viewer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      z-index: 9000;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: zoom-out;
    }
    #img-viewer.hidden { display: none; }
    #img-viewer img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: var(--radius-md);
    }

    /* Search Results */
    .search-results {
      display: none;
      padding: 0 12px 8px;
    }
    .search-results.show { display: block; }
    .search-result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
    }
    .search-result-item:hover { background: var(--bg-hover); }
    .search-result-item img {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      object-fit: cover;
      background: var(--bg-tertiary);
    }
    .search-result-name {
      font-size: 14px;
      font-weight: 500;
    }
    .search-result-handle {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Create Group/Channel Modal */
    .create-type-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .create-type-btn {
      flex: 1;
      padding: 16px;
      background: var(--bg-tertiary);
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      text-align: center;
      transition: var(--transition);
      font-family: inherit;
    }
    .create-type-btn.active {
      border-color: var(--accent);
      color: var(--accent-light);
      background: rgba(124,58,237,0.1);
    }
    .create-type-btn:hover:not(.active) {
      border-color: var(--border-light);
    }
    .create-type-btn .icon { font-size: 24px; margin-bottom: 6px; }
    .create-type-btn .label { font-size: 13px; font-weight: 500; }

    /* Room Info */
    .member-entry {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      transition: var(--transition);
    }
    .member-entry:hover { background: var(--bg-hover); }
    .member-entry img {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      object-fit: cover;
      background: var(--bg-tertiary);
    }
    .member-entry-info { flex: 1; }
    .member-entry-name { font-size: 14px; font-weight: 500; }
    .member-entry-handle { font-size: 12px; color: var(--text-muted); }
    .member-entry-role {
      font-size: 11px;
      color: var(--accent-light);
      font-weight: 500;
    }
    .member-remove {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: var(--text-ghost);
      border-radius: var(--radius-full);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    .member-remove:hover {
      background: rgba(239,68,68,0.2);
      color: var(--red);
    }

    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      padding: 12px 20px;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 500;
      color: white;
      box-shadow: var(--shadow-md);
      animation: toastIn 0.3s ease;
      max-width: 320px;
    }
    .toast.success { background: var(--green); }
    .toast.error { background: var(--red); }
    .toast.info { background: var(--blue); }
    @keyframes toastIn {
      from { opacity: 0; transform: translateX(40px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /*  CALL MODALS                                   */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .call-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      z-index: 8000;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
    }
    .call-overlay.show { display: flex; }

    .call-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: 40px;
      text-align: center;
      box-shadow: 0 0 40px rgba(124,58,237,0.2);
      animation: slideUp 0.3s ease;
    }
    .call-card h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .call-card .call-status {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 24px;
    }
    .call-buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
    }
    .call-btn {
      width: 56px;
      height: 56px;
      border: none;
      border-radius: var(--radius-full);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: var(--transition);
    }
    .call-btn-accept {
      background: var(--green);
      color: white;
      box-shadow: 0 0 20px var(--green-glow);
    }
    .call-btn-accept:hover { transform: scale(1.1); }
    .call-btn-reject {
      background: var(--red);
      color: white;
    }
    .call-btn-reject:hover { transform: scale(1.1); }

    .video-call-overlay {
      position: fixed;
      inset: 0;
      background: black;
      z-index: 8000;
      display: none;
    }
    .video-call-overlay.show { display: block; }
    .video-call-overlay video.remote {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .video-call-overlay video.local {
      position: absolute;
      bottom: 100px;
      right: 20px;
      width: 140px;
      height: 190px;
      border: 2px solid white;
      border-radius: var(--radius-md);
      object-fit: cover;
      background: #222;
    }
    .video-call-controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    /*  RESPONSIVE                                    */
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    @media (max-width: 768px) {
      #sidebar {
        width: 100%;
        min-width: 100%;
        position: absolute;
        z-index: 100;
      }
      #sidebar.chat-open { display: none; }

      #chat-area {
        position: absolute;
        inset: 0;
        display: none;
      }
      #chat-area.show { display: flex; }

      .chat-header-back { display: flex; }

      .msg { max-width: 85%; }
    }
  </style>
</head>
<body>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  AUTH SCREEN                                   -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="auth-screen">
    <div class="auth-container">
      <div class="auth-logo">
        <h1>EchoVoid</h1>
        <p>Encrypted messaging for the modern age</p>
      </div>

      <div class="auth-card">
        <div id="email-section">
          <h2>Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ</h2>
          <p class="subtitle">Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ email Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ¸Ğ»Ğ¸ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸</p>
          <div class="input-group">
            <label>Email</label>
            <input type="email" id="email-input" placeholder="you@example.com" autocomplete="email">
          </div>
          <button class="btn btn-primary" onclick="sendCode()" id="send-code-btn">
            ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´
          </button>
        </div>

        <div id="code-section">
          <h2>ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ´Ğ°</h2>
          <p class="subtitle" id="code-subtitle">ĞšĞ¾Ğ´ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ½Ğ° email</p>
          <div class="input-group">
            <label>ĞšĞ¾Ğ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ</label>
            <input type="text" id="code-input" placeholder="000000" maxlength="6" inputmode="numeric" autocomplete="one-time-code">
          </div>
          <button class="btn btn-primary" onclick="login()" id="login-btn">
            Ğ’Ğ¾Ğ¹Ñ‚Ğ¸
          </button>
          <div style="margin-top:12px">
            <button class="btn btn-secondary" onclick="backToEmail()">
              â† Ğ”Ñ€ÑƒĞ³Ğ¾Ğ¹ email
            </button>
          </div>
        </div>
      </div>

      <div class="auth-footer">
        ĞĞ°Ğ¶Ğ¸Ğ¼Ğ°Ñ Â«ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´Â», Ğ²Ñ‹ Ğ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚Ğµ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  MAIN APP                                      -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="app">
    <!-- SIDEBAR -->
    <div id="sidebar">
      <div class="sidebar-header">
        <h2>EchoVoid</h2>
        <div class="header-actions">
          <button class="header-btn" onclick="openCreate()" title="Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
          <button class="header-btn" onclick="openProfile()" title="ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          </button>
        </div>
      </div>

      <div class="search-box">
        <div class="search-input-wrap">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" id="search-input" placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ»ÑĞ´ĞµĞ¹..." oninput="searchUsers(this.value)">
        </div>
      </div>

      <div id="search-results" class="search-results"></div>

      <div class="sidebar-tabs">
        <button class="sidebar-tab active" onclick="switchTab('chats', this)">Ğ§Ğ°Ñ‚Ñ‹</button>
        <button class="sidebar-tab" onclick="switchTab('groups', this)">Ğ“Ñ€ÑƒĞ¿Ğ¿Ñ‹</button>
        <button class="sidebar-tab" onclick="switchTab('channels', this)">ĞšĞ°Ğ½Ğ°Ğ»Ñ‹</button>
      </div>

      <div class="contact-list" id="contact-list">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ’¬</div>
          <h3>ĞĞµÑ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²</h3>
          <p>ĞĞ°Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ»ÑĞ´ĞµĞ¹ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ğ¾Ğ¸ÑĞº<br>Ğ¸ Ğ½Ğ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ</p>
        </div>
      </div>
    </div>

    <!-- CHAT AREA -->
    <div id="chat-area">
      <div id="no-chat">
        <div class="logo-big">ğŸ’¬</div>
        <h2>EchoVoid</h2>
        <p>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ</p>
      </div>

      <div id="active-chat">
        <div class="chat-header">
          <button class="chat-header-back" onclick="goBack()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <img id="ch-avatar" class="chat-header-avatar" src="/default.png" onclick="openRoomInfo()">
          <div class="chat-header-info" onclick="openRoomInfo()">
            <h3 id="ch-name">Ğ˜Ğ¼Ñ</h3>
            <span id="ch-status">Ğ¾Ñ„Ñ„Ğ»Ğ°Ğ¹Ğ½</span>
          </div>
          <div class="chat-header-actions">
            <button class="header-btn" onclick="startCallFromChat()" title="ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ½Ğ¸Ñ‚ÑŒ">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
            </button>
            <button class="header-btn" onclick="startVideoCallFromChat()" title="Ğ’Ğ¸Ğ´ĞµĞ¾Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
            </button>
          </div>
        </div>

        <div id="messages"></div>

        <div class="typing-indicator" id="typing-indicator"></div>

        <div class="input-bar">
          <div class="input-actions">
            <button class="input-action-btn" onclick="document.getElementById('file-input').click()" title="Ğ¤Ğ°Ğ¹Ğ»">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
            </button>
          </div>
          <div class="input-text-wrap">
            <textarea id="msg-input" rows="1" placeholder="ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..." onkeydown="handleMsgKey(event)" oninput="autoResize(this); sendTyping()"></textarea>
          </div>
          <button class="send-btn" onclick="sendMessage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>

        <input type="file" id="file-input" hidden onchange="uploadFile(this)">
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  MODALS                                        -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

  <!-- Profile Modal -->
  <div id="profile-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ĞœĞ¾Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</h3>
        <button class="modal-close" onclick="closeProfile()">âœ•</button>
      </div>
      <div class="profile-avatar-wrap">
        <img id="my-avatar" class="profile-avatar" src="/default.png">
        <div style="margin-top:12px">
          <button class="btn btn-secondary" onclick="document.getElementById('avatar-input').click()" style="width:auto; padding:8px 16px; font-size:13px">
            ğŸ“· Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€
          </button>
          <input type="file" id="avatar-input" hidden accept="image/*" onchange="uploadAvatar(this)">
        </div>
      </div>
      <div class="input-group">
        <label>Ğ˜Ğ¼Ñ</label>
        <input type="text" id="edit-display-name" placeholder="Ğ’Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ">
      </div>
      <div class="input-group">
        <label>Username</label>
        <input type="text" id="edit-username" placeholder="username">
      </div>
      <div class="input-group">
        <label>Ğ ÑĞµĞ±Ğµ</label>
        <input type="text" id="edit-bio" placeholder="Ğ Ğ°ÑÑĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¾ ÑĞµĞ±Ğµ..." maxlength="200">
      </div>
      <button class="btn btn-primary" onclick="saveProfile()" style="margin-top:8px">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
      <button class="btn btn-secondary" onclick="logout()" style="margin-top:8px; color:var(--red)">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
    </div>
  </div>

  <!-- User Profile Modal -->
  <div id="user-profile-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</h3>
        <button class="modal-close" onclick="closeUserProfile()">âœ•</button>
      </div>
      <div class="profile-avatar-wrap">
        <img id="up-ava" class="profile-avatar" src="/default.png">
      </div>
      <div id="up-name" class="profile-name"></div>
      <div id="up-handle" class="profile-handle"></div>
      <div id="up-status" class="profile-status">
        <div class="profile-status-dot"></div>
        <span id="up-status-text"></span>
      </div>
      <div id="up-bio" class="profile-bio"></div>
      <div style="font-size:12px; color:var(--text-ghost); text-align:center;">
        Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½: <span id="up-joined"></span>
      </div>
      <div id="up-avatars-section" class="profile-section" style="display:none">
        <div class="profile-section-title">ĞĞ²Ğ°Ñ‚Ğ°Ñ€Ñ‹</div>
        <div id="up-avatars-grid" class="avatar-grid"></div>
      </div>
      <button id="up-msg-btn" class="btn btn-primary" onclick="sendMessageToUser()" style="margin-top:16px">
        ğŸ’¬ ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ
      </button>
    </div>
  </div>

  <!-- Create Group/Channel Modal -->
  <div id="create-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ</h3>
        <button class="modal-close" onclick="closeCreate()">âœ•</button>
      </div>
      <div class="create-type-selector">
        <button class="create-type-btn active" onclick="selectCreateType('group', this)">
          <div class="icon">ğŸ‘¥</div>
          <div class="label">Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ°</div>
        </button>
        <button class="create-type-btn" onclick="selectCreateType('channel', this)">
          <div class="icon">ğŸ“¢</div>
          <div class="label">ĞšĞ°Ğ½Ğ°Ğ»</div>
        </button>
      </div>
      <div class="input-group">
        <label>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</label>
        <input type="text" id="create-name" placeholder="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ...">
      </div>
      <div class="input-group">
        <label>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</label>
        <input type="text" id="create-desc" placeholder="ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)">
      </div>
      <button class="btn btn-primary" onclick="createRoom()">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ</button>
    </div>
  </div>

  <!-- Room Info Modal -->
  <div id="room-info-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="ri-title">Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ</h3>
        <button class="modal-close" onclick="closeRoomInfo()">âœ•</button>
      </div>
      <div class="profile-avatar-wrap">
        <img id="ri-ava" class="profile-avatar" src="/default.png">
        <div id="ri-ava-edit" style="display:none; margin-top:8px">
          <button class="btn btn-secondary" onclick="document.getElementById('room-ava-input').click()" style="width:auto; padding:6px 12px; font-size:12px">ğŸ“· Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button>
          <input type="file" id="room-ava-input" hidden accept="image/*" onchange="uploadRoomAvatar(this)">
        </div>
      </div>
      <div id="ri-name-display" class="profile-name"></div>
      <div id="ri-desc-display" class="profile-bio" style="display:none"></div>
      <div id="ri-member-count" style="text-align:center; font-size:13px; color:var(--text-muted); margin-bottom:16px"></div>
      <div id="ri-edit-section" style="display:none">
        <div class="input-group">
          <label>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</label>
          <input type="text" id="ri-name-input">
        </div>
        <div class="input-group">
          <label>ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</label>
          <input type="text" id="ri-desc-input">
        </div>
        <button class="btn btn-primary" onclick="saveRoomInfo()" style="margin-bottom:16px">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
      </div>
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px">
        <div class="profile-section-title" style="margin:0">Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸</div>
        <button id="ri-add-btn" class="btn btn-secondary" onclick="showAddMemberUI()" style="width:auto; padding:4px 12px; font-size:12px; display:none">+ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
      </div>
      <div id="ri-add-member" style="display:none; margin-bottom:12px">
        <input type="text" id="ri-add-search" class="input-group input" placeholder="ĞŸĞ¾Ğ¸ÑĞº..." oninput="searchMemberToAdd(this.value)" style="width:100%; padding:8px 12px; background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-md); color:var(--text-primary); font-family:inherit; outline:none; margin-bottom:8px">
        <div id="ri-add-results"></div>
      </div>
      <div id="ri-members-list"></div>
      <button class="btn btn-secondary" onclick="leaveRoom()" style="margin-top:16px; color:var(--red)">ğŸšª ĞŸĞ¾ĞºĞ¸Ğ½ÑƒÑ‚ÑŒ</button>
    </div>
  </div>

  <!-- Image Viewer -->
  <div id="img-viewer" class="hidden" onclick="this.classList.add('hidden')">
    <img id="img-viewer-img" src="">
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  CALL UI                                       -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <audio id="callSound" src="/ringtone.mp3" loop></audio>

  <!-- Incoming Call -->
  <div id="incomingCallModal" class="call-overlay">
    <div class="call-card">
      <h3>ğŸ“ Ğ’Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ Ğ·Ğ²Ğ¾Ğ½Ğ¾Ğº</h3>
      <div class="call-status">ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°...</div>
      <div class="call-buttons">
        <button class="call-btn call-btn-accept" onclick="acceptCall()">ğŸ“</button>
        <button class="call-btn call-btn-reject" onclick="rejectCall()">âœ•</button>
      </div>
    </div>
  </div>

  <!-- Active Video Call -->
  <div id="activeCallModal" class="video-call-overlay">
    <video id="remoteVideo" class="remote" autoplay playsinline></video>
    <video id="localVideo" class="local" autoplay muted playsinline></video>
    <div class="video-call-controls">
      <button class="call-btn call-btn-reject" onclick="endCall()">âœ•</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  JAVASCRIPT                                    -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  GLOBALS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let ME = null;
    let ws = null;
    let ROOM = null;
    let ROOM_TYPE = null;
    let CONTACT = null;
    let currentTab = 'chats';
    let typingTimeout = null;
    let createType = 'group';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    function toast(msg, type = 'info') {
      const c = document.getElementById('toast-container');
      const t = document.createElement('div');
      t.className = 'toast ' + type;
      t.textContent = msg;
      c.appendChild(t);
      setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
    }

    function getCookie(n) {
      const v = document.cookie.match('(^|;)\\s*' + n + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }

    function formatTime(ts) {
      if (!ts) return '';
      const d = new Date(ts * 1000);
      return d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(ts) {
      if (!ts) return '';
      const d = new Date(ts * 1000);
      const today = new Date();
      if (d.toDateString() === today.toDateString()) return 'Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ';
      const y = new Date(today); y.setDate(y.getDate() - 1);
      if (d.toDateString() === y.toDateString()) return 'Ğ’Ñ‡ĞµÑ€Ğ°';
      return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
    }

    function formatFileSize(bytes) {
      if (!bytes) return '';
      if (bytes < 1024) return bytes + ' Ğ‘';
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' ĞšĞ‘';
      return (bytes / 1048576).toFixed(1) + ' ĞœĞ‘';
    }

    function autoResize(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    }

    function viewImage(url) {
      document.getElementById('img-viewer-img').src = url;
      document.getElementById('img-viewer').classList.remove('hidden');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  AUTH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function checkAuth() {
      try {
        const r = await fetch('/api/auth/me');
        const d = await r.json();
        if (d.authenticated && d.user) {
          ME = d.user;
          showApp();
        }
      } catch(e) {}
    }

    async function sendCode() {
      const email = document.getElementById('email-input').value.trim();
      if (!email || !email.includes('@')) return toast('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ email', 'error');
      const btn = document.getElementById('send-code-btn');
      btn.disabled = true;
      btn.textContent = 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°...';
      try {
        const r = await fetch('/api/auth/send-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const d = await r.json();
        if (d.success) {
          document.getElementById('email-section').style.display = 'none';
          document.getElementById('code-section').classList.add('show');
          document.getElementById('code-subtitle').textContent = `ĞšĞ¾Ğ´ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ½Ğ° ${email}`;
          document.getElementById('code-input').focus();
          toast('ĞšĞ¾Ğ´ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½!', 'success');
        } else {
          toast(d.error || 'ĞÑˆĞ¸Ğ±ĞºĞ°', 'error');
        }
      } catch(e) { toast('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸', 'error'); }
      btn.disabled = false;
      btn.textContent = 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´';
    }

    function backToEmail() {
      document.getElementById('email-section').style.display = 'block';
      document.getElementById('code-section').classList.remove('show');
    }

    async function login() {
      const email = document.getElementById('email-input').value.trim();
      const code = document.getElementById('code-input').value.trim();
      if (!code || code.length !== 6) return toast('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ 6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´', 'error');
      const btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.textContent = 'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°...';
      try {
        const r = await fetch('/api/auth/login-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, code })
        });
        const d = await r.json();
        if (d.success && d.user) {
          ME = d.user;
          showApp();
          toast('Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ!', 'success');
        } else {
          toast(d.error || 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´', 'error');
        }
      } catch(e) { toast('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸', 'error'); }
      btn.disabled = false;
      btn.textContent = 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸';
    }

    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST' });
      location.reload();
    }

    function showApp() {
      document.getElementById('auth-screen').classList.add('hidden');
      const app = document.getElementById('app');
      app.classList.add('show');
      document.getElementById('my-avatar').src = ME.avatar_url || '/default.png';
      document.getElementById('edit-display-name').value = ME.display_name || '';
      document.getElementById('edit-username').value = ME.username || '';
      document.getElementById('edit-bio').value = ME.bio || '';
      connectWS();
      loadContacts();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  WEBSOCKET
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function connectWS() {
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      ws = new WebSocket(`${proto}://${location.host}`);

      ws.onopen = () => {
        const token = getCookie('session_token');
        ws.send(JSON.stringify({ type: 'auth', token }));
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        if (msg.type === 'auth_ok') {
          console.log('âœ… WS Connected');
        }

        if (msg.type === 'new_message') {
          if (msg.message.room_id === ROOM) {
            appendMessage(msg.message);
            scrollToBottom();
            // Mark as read
            fetch(`/api/messages/${ROOM}/read`, { method: 'POST' });
          }
          loadContacts();
        }

        if (msg.type === 'typing') {
          if (msg.roomId === ROOM) {
            showTyping(msg.name);
          }
        }

        // CALLS
        if (msg.type === 'call_made') handleIncomingCall(msg);
        if (msg.type === 'answer_made' && peerConnection) {
          peerConnection.setRemoteDescription(new RTCSessionDescription(msg.answer));
        }
        if (msg.type === 'ice_candidate' && peerConnection) {
          peerConnection.addIceCandidate(msg.candidate);
        }
        if (msg.type === 'call_rejected') {
          toast('Ğ—Ğ²Ğ¾Ğ½Ğ¾Ğº ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½', 'info');
          endCall();
        }
      };

      ws.onclose = () => {
        console.log('WS disconnected, reconnecting...');
        setTimeout(connectWS, 3000);
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CONTACTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadContacts() {
      try {
        const r = await fetch('/api/contacts');
        const contacts = await r.json();
        renderContacts(contacts);
      } catch(e) {}
    }

    function renderContacts(contacts) {
      const list = document.getElementById('contact-list');

      // Filter by tab
      let filtered = contacts;
      // For now show all in chats tab

      if (!filtered.length) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ’¬</div>
            <h3>ĞĞµÑ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²</h3>
            <p>ĞĞ°Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ»ÑĞ´ĞµĞ¹ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ğ¾Ğ¸ÑĞº</p>
          </div>`;
        return;
      }

      list.innerHTML = '';
      filtered.forEach(c => {
        const div = document.createElement('div');
        div.className = 'contact-item' + (c.room_id === ROOM ? ' active' : '');
        div.onclick = () => openChat(c);

        let lastMsg = c.last_message || '';
        if (c.last_message_type === 'image') lastMsg = 'ğŸ“· Ğ¤Ğ¾Ñ‚Ğ¾';
        else if (c.last_message_type === 'video') lastMsg = 'ğŸ¥ Ğ’Ğ¸Ğ´ĞµĞ¾';
        else if (c.last_message_type === 'voice') lastMsg = 'ğŸ¤ Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğµ';
        else if (c.last_message_type === 'file') lastMsg = 'ğŸ“ Ğ¤Ğ°Ğ¹Ğ»';
        else if (c.last_message_type === 'gif') lastMsg = 'ğŸ­ GIF';
        if (lastMsg && lastMsg.startsWith('/uploads/')) lastMsg = 'ğŸ“ Ğ¤Ğ°Ğ¹Ğ»';

        div.innerHTML = `
          <div class="contact-avatar">
            <img src="${c.avatar_url || '/default.png'}" alt="">
            ${c.is_online ? '<div class="online-dot"></div>' : ''}
          </div>
          <div class="contact-info">
            <div class="contact-name">${esc(c.display_name || c.username)}</div>
            <div class="contact-last-msg">${esc(lastMsg)}</div>
          </div>
          <div class="contact-meta">
            <div class="contact-time">${c.last_message_time ? formatTime(c.last_message_time) : ''}</div>
            ${c.unread_count > 0 ? `<div class="unread-badge">${c.unread_count}</div>` : ''}
          </div>
        `;
        list.appendChild(div);
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SEARCH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let searchTimeout = null;
    async function searchUsers(q) {
      const results = document.getElementById('search-results');
      if (q.length < 2) { results.classList.remove('show'); results.innerHTML = ''; return; }
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(async () => {
        try {
          const r = await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
          const users = await r.json();
          results.classList.add('show');
          if (!users.length) {
            results.innerHTML = '<div style="padding:12px; text-align:center; color:var(--text-ghost); font-size:13px">ĞĞ¸ĞºĞ¾Ğ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</div>';
            return;
          }
          results.innerHTML = '';
          users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'search-result-item';
            div.innerHTML = `
              <img src="${u.avatar_url || '/default.png'}">
              <div>
                <div class="search-result-name">${esc(u.display_name || u.username)}</div>
                <div class="search-result-handle">@${esc(u.username)}</div>
              </div>
            `;
            div.onclick = () => startChatWith(u);
            results.appendChild(div);
          });
        } catch(e) {}
      }, 300);
    }

    async function startChatWith(user) {
      document.getElementById('search-input').value = '';
      document.getElementById('search-results').classList.remove('show');
      try {
        const r = await fetch('/api/contacts/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contactId: user.id })
        });
        const d = await r.json();
        if (d.success) {
          ROOM = d.roomId;
          ROOM_TYPE = 'direct';
          CONTACT = user.id;
          loadContacts();
          openChatUI(user);
          loadMessages();
        }
      } catch(e) { toast('ĞÑˆĞ¸Ğ±ĞºĞ°', 'error'); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  OPEN CHAT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openChat(contact) {
      ROOM = contact.room_id;
      ROOM_TYPE = 'direct';
      CONTACT = contact.contact_id;
      openChatUI(contact);
      loadMessages();
      loadContacts();

      // Mobile
      document.getElementById('sidebar').classList.add('chat-open');
      document.getElementById('chat-area').classList.add('show');
    }

    function openChatUI(user) {
      document.getElementById('no-chat').classList.add('hidden');
      document.getElementById('active-chat').classList.add('show');
      document.getElementById('ch-avatar').src = user.avatar_url || '/default.png';
      document.getElementById('ch-name').textContent = user.display_name || user.username;
      document.getElementById('ch-status').textContent = user.is_online ? 'Ğ² ÑĞµÑ‚Ğ¸' : 'Ğ¾Ñ„Ñ„Ğ»Ğ°Ğ¹Ğ½';
    }

    function goBack() {
      document.getElementById('sidebar').classList.remove('chat-open');
      document.getElementById('chat-area').classList.remove('show');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MESSAGES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadMessages() {
      if (!ROOM) return;
      try {
        const r = await fetch(`/api/messages/${ROOM}`);
        const msgs = await r.json();
        const container = document.getElementById('messages');
        container.innerHTML = '';
        let lastDate = '';
        msgs.forEach(m => {
          const date = formatDate(m.created_at);
          if (date !== lastDate) {
            container.innerHTML += `<div class="date-sep"><span>${date}</span></div>`;
            lastDate = date;
          }
          appendMessage(m);
        });
        scrollToBottom();
        fetch(`/api/messages/${ROOM}/read`, { method: 'POST' });
      } catch(e) {}
    }

    function appendMessage(m) {
      const container = document.getElementById('messages');
      const isMe = m.from_user_id === ME.id;
      const div = document.createElement('div');
      div.className = `msg ${isMe ? 'out' : 'in'}`;

      let content = '';
      const type = m.message_type || 'text';

      if (type === 'image' || type === 'gif') {
        content = `<img class="msg-image" src="${m.file_url || m.content}" onclick="viewImage('${m.file_url || m.content}')">`;
      } else if (type === 'video') {
        content = `<video class="msg-video" controls><source src="${m.file_url || m.content}"></video>`;
      } else if (type === 'voice') {
        const bars = Array.from({length: 20}, () =>
          `<div class="voice-wave-bar" style="height:${Math.random()*20+5}px"></div>`
        ).join('');
        content = `
          <div class="voice-msg">
            <button class="voice-play-btn" onclick="playVoice(this, '${m.file_url || m.content}')">â–¶</button>
            <div class="voice-wave">${bars}</div>
          </div>`;
      } else if (type === 'file') {
        content = `
          <a class="msg-file" href="${m.file_url || m.content}" download="${m.file_name || 'file'}" target="_blank">
            <div class="msg-file-icon">${m.file_icon || 'ğŸ“'}</div>
            <div>
              <div class="msg-file-name">${esc(m.file_name || 'Ğ¤Ğ°Ğ¹Ğ»')}</div>
              <div class="msg-file-size">${formatFileSize(m.file_size)}</div>
            </div>
          </a>`;
      } else {
        content = esc(m.content || '');
      }

      const senderHtml = (!isMe && ROOM_TYPE !== 'direct') ?
        `<div class="msg-sender">${esc(m.display_name || m.username)}</div>` : '';

      div.innerHTML = `
        <div class="msg-bubble">
          ${senderHtml}
          ${content}
          <div class="msg-time">${formatTime(m.created_at)}</div>
        </div>
      `;
      container.appendChild(div);
    }

    function scrollToBottom() {
      const el = document.getElementById('messages');
      setTimeout(() => { el.scrollTop = el.scrollHeight; }, 50);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SEND MESSAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function sendMessage() {
      const input = document.getElementById('msg-input');
      const text = input.value.trim();
      if (!text || !ROOM || !ws) return;
      ws.send(JSON.stringify({ type: 'message', roomId: ROOM, content: text }));
      input.value = '';
      input.style.height = 'auto';
    }

    function handleMsgKey(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    function sendTyping() {
      if (!ROOM || !ws) return;
      clearTimeout(typingTimeout);
      ws.send(JSON.stringify({ type: 'typing', roomId: ROOM }));
    }

    let typingHideTimeout = null;
    function showTyping(name) {
      const el = document.getElementById('typing-indicator');
      el.textContent = name + ' Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ°ĞµÑ‚...';
      clearTimeout(typingHideTimeout);
      typingHideTimeout = setTimeout(() => { el.textContent = ''; }, 3000);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FILE UPLOAD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function uploadFile(input) {
      if (!input.files[0] || !ROOM) return;
      const file = input.files[0];
      const formData = new FormData();
      formData.append('file', file);
      formData.append('roomId', ROOM);
      formData.append('messageType', 'auto');
      try {
        toast('ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ°...', 'info');
        const r = await fetch('/api/messages/upload', { method: 'POST', body: formData });
        const d = await r.json();
        if (!d.success) toast(d.error || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸', 'error');
      } catch(e) { toast('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸', 'error'); }
      input.value = '';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  VOICE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentAudio = null;
    function playVoice(btn, url) {
      if (currentAudio) { currentAudio.pause(); currentAudio = null; }
      const audio = new Audio(url);
      currentAudio = audio;
      btn.textContent = 'â¸';
      audio.play();
      audio.onended = () => { btn.textContent = 'â–¶'; currentAudio = null; };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PROFILE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openProfile() { document.getElementById('profile-modal').classList.remove('hidden'); }
    function closeProfile() { document.getElementById('profile-modal').classList.add('hidden'); }

    async function saveProfile() {
      const display_name = document.getElementById('edit-display-name').value.trim();
      const username = document.getElementById('edit-username').value.trim();
      const bio = document.getElementById('edit-bio').value.trim();
      try {
        await fetch('/api/profile/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ display_name, username })
        });
        await fetch('/api/profile/bio', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bio })
        });
        ME.display_name = display_name;
        ME.username = username;
        ME.bio = bio;
        toast('ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½', 'success');
      } catch(e) { toast('ĞÑˆĞ¸Ğ±ĞºĞ°', 'error'); }
    }

    async function uploadAvatar(input) {
      if (!input.files[0]) return;
      const formData = new FormData();
      formData.append('file', input.files[0]);
      try {
        const r = await fetch('/api/profile/avatar', { method: 'POST', body: formData });
        const d = await r.json();
        if (d.success) {
          document.getElementById('my-avatar').src = d.avatarUrl;
          ME.avatar_url = d.avatarUrl;
          toast('ĞĞ²Ğ°Ñ‚Ğ°Ñ€ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½', 'success');
        }
      } catch(e) { toast('ĞÑˆĞ¸Ğ±ĞºĞ°', 'error'); }
      input.value = '';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  USER PROFILE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let viewingUserId = null;
    async function openUserProfile(userId) {
      viewingUserId = userId;
      try {
        const r = await fetch(`/api/users/${userId}/profile`);
        const user = await r.json();
        document.getElementById('up-ava').src = user.avatar_url || '/default.png';
        document.getElementById('up-name').textContent = user.display_name || user.username;
        document.getElementById('up-handle').textContent = '@' + (user.username || '');
        const statusEl = document.getElementById('up-status');
        const statusText = document.getElementById('up-status-text');
        if (user.is_online) { statusEl.className = 'profile-status online'; statusText.textContent = 'Ğ² ÑĞµÑ‚Ğ¸'; }
        else { statusEl.className = 'profile-status offline'; statusText.textContent = user.last_seen ? 'Ğ±Ñ‹Ğ»(Ğ°) ' + formatLastSeen(user.last_seen) : 'Ğ¾Ñ„Ñ„Ğ»Ğ°Ğ¹Ğ½'; }
        const bioEl = document.getElementById('up-bio');
        bioEl.textContent = user.bio || '';
        bioEl.style.display = user.bio ? 'block' : 'none';
        document.getElementById('up-joined').textContent = new Date(user.created_at * 1000).toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' });
        const grid = document.getElementById('up-avatars-grid');
        const section = document.getElementById('up-avatars-section');
        if (user.avatars && user.avatars.length > 0) {
          section.style.display = 'block';
          grid.innerHTML = '';
          user.avatars.forEach(av => {
            const item = document.createElement('div');
            item.className = 'avatar-grid-item' + (av.url === user.avatar_url ? ' current' : '');
            item.innerHTML = `<img src="${av.url}">`;
            item.onclick = () => viewImage(av.url);
            grid.appendChild(item);
          });
        } else { section.style.display = 'none'; }
        document.getElementById('up-msg-btn').style.display = userId === ME.id ? 'none' : 'block';
        document.getElementById('user-profile-modal').classList.remove('hidden');
      } catch(e) { toast('ĞÑˆĞ¸Ğ±ĞºĞ°', 'error'); }
    }
    function closeUserProfile() { document.getElementById('user-profile-modal').classList.add('hidden'); viewingUserId = null; }
    function sendMessageToUser() { if (viewingUserId) { closeUserProfile(); startChatWith({ id: viewingUserId }); } }
    function formatLastSeen(ts) {
      if (!ts) return 'Ğ´Ğ°Ğ²Ğ½Ğ¾';
      const diff = Math.floor(Date.now()/1000) - ts;
      if (diff < 60) return 'Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚Ğ¾';
      if (diff < 3600) return Math.floor(diff/60) + ' Ğ¼Ğ¸Ğ½ Ğ½Ğ°Ğ·Ğ°Ğ´';
      if (diff < 86400) return Math.floor(diff/3600) + ' Ñ‡ Ğ½Ğ°Ğ·Ğ°Ğ´';
      return new Date(ts*1000).toLocaleDateString('ru-RU', { day:'numeric', month:'short' });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  TABS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function switchTab(tab, btn) {
      currentTab = tab;
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      loadContacts();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CREATE GROUP/CHANNEL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openCreate() { document.getElementById('create-modal').classList.remove('hidden'); }
    function closeCreate() { document.getElementById('create-modal').classList.add('hidden'); }
    function selectCreateType(type, btn) {
      createType = type;
      document.querySelectorAll('.create-type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }
    async function createRoom() {
      const name = document.getElementById('create-name').value.trim();
      const desc = document.getElementById('create-desc').value.trim();
      if (!name || name.length < 2) return toast('ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°', 'error');
      try {
        const url = createType === 'channel' ? '/api/channels' : '/api/groups';
        const r = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description: desc })
        });
        const d = await r.json();
        if (d.success) {
          toast(`${createType === 'channel' ? 'ĞšĞ°Ğ½Ğ°Ğ»' : 'Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ°'} ÑĞ¾Ğ·Ğ´Ğ°Ğ½(Ğ°)!`, 'success');
          closeCreate();
          loadContacts();
        } else { toast(d.error || 'ĞÑˆĞ¸Ğ±ĞºĞ°', 'error'); }
      } catch(e) { toast('ĞÑˆĞ¸Ğ±ĞºĞ°', 'error'); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ROOM INFO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentRoomInfo = null;
    async function openRoomInfo() {
      if (!ROOM) return;
      if (ROOM_TYPE === 'direct' && CONTACT) { openUserProfile(CONTACT); return; }
      try {
        const r = await fetch(`/api/rooms/${ROOM}/info`);
        const data = await r.json();
        if (data.error) { toast(data.error, 'error'); return; }
        currentRoomInfo = data;
        const isAdmin = data.my_role === 'admin';
        document.getElementById('ri-title').textContent = data.type === 'channel' ? 'ĞšĞ°Ğ½Ğ°Ğ»' : 'Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ°';
        document.getElementById('ri-ava').src = data.avatar_url || '/default.png';
        document.getElementById('ri-name-display').textContent = data.name || '';
        document.getElementById('ri-desc-display').textContent = data.description || '';
        document.getElementById('ri-desc-display').style.display = data.description ? 'block' : 'none';
        document.getElementById('ri-member-count').textContent = `${data.member_count} ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²`;
        document.getElementById('ri-edit-section').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('ri-ava-edit').style.display = isAdmin ? 'flex' : 'none';
        document.getElementById('ri-add-btn').style.display = isAdmin ? 'inline-block' : 'none';
        if (isAdmin) {
          document.getElementById('ri-name-input').value = data.name || '';
          document.getElementById('ri-desc-input').value = data.description || '';
        }
        renderRoomMembers(data.members, isAdmin);
        document.getElementById('room-info-modal').classList.remove('hidden');
      } catch(e) { toast('ĞÑˆĞ¸Ğ±ĞºĞ°', 'error'); }
    }
    function closeRoomInfo() { document.getElementById('room-info-modal').classList.add('hidden'); currentRoomInfo = null; }
    function renderRoomMembers(members, isAdmin) {
      const list = document.getElementById('ri-members-list');
      list.innerHTML = '';
      members.forEach(m => {
        const el = document.createElement('div');
        el.className = 'member-entry';
        const isMe = m.id === ME.id;
        el.innerHTML = `
          <img src="${m.avatar_url || '/default.png'}" onclick="openUserProfile('${m.id}')" style="cursor:pointer">
          <div class="member-entry-info" onclick="openUserProfile('${m.id}')" style="cursor:pointer">
            <div class="member-entry-name">${esc(m.display_name || m.username)}${isMe ? ' (Ğ²Ñ‹)' : ''}</div>
            ${m.role === 'admin' ? '<div class="member-entry-role">ĞĞ´Ğ¼Ğ¸Ğ½</div>' : `<div class="member-entry-handle">@${esc(m.username)}</div>`}
          </div>
          ${isAdmin && !isMe && m.role !== 'admin' ? `<button class="member-remove" onclick="removeMember('${m.id}')">âœ•</button>` : ''}
        `;
        list.appendChild(el);
      });
    }
    async function saveRoomInfo() {
      const name = document.getElementById('ri-name-input').value.trim();
      const description = document.getElementById('ri-desc-input').value.trim();
      if (!name || name.length < 2) return toast('ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°', 'error');
      try {
        const r = await fetch(`/api/rooms/${ROOM}/update`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name, description}) });
        const d = await r.json();
        if (d.success) { toast('Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾', 'success'); document.getElementById('ri-name-display').textContent = name; document.getElementById('ch-name').textContent = name; loadContacts(); }
      } catch(e) { toast('ĞÑˆĞ¸Ğ±ĞºĞ°', 'error'); }
    }
    async function uploadRoomAvatar(input) {
      if (!ROOM || !input.files[0]) return;
      const formData = new FormData(); formData.append('file', input.files[0]);
      try {
        const r = await fetch(`/api/rooms/${ROOM}/update`, { method:'POST', body:formData });
        const d = await r.json();
        if (d.success && d.room) { document.getElementById('ri-ava').src = d.room.avatar_url; loadContacts(); toast('ĞĞ²Ğ°Ñ‚Ğ°Ñ€ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½', 'success'); }
      } catch(e) {} input.value = '';
    }
    async function removeMember(userId) {
      if (!confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ?')) return;
      try { const r = await fetch(`/api/rooms/${ROOM}/remove-member`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId}) }); const d = await r.json(); if (d.success) { toast('Ğ£Ğ´Ğ°Ğ»Ñ‘Ğ½', 'success'); openRoomInfo(); } } catch(e) {}
    }
    function showAddMemberUI() { document.getElementById('ri-add-member').style.display = 'block'; document.getElementById('ri-add-search').focus(); }
    async function searchMemberToAdd(q) {
      if (q.length < 2) { document.getElementById('ri-add-results').innerHTML = ''; return; }
      const r = await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
      const users = await r.json();
      const existing = (currentRoomInfo?.members||[]).map(m=>m.id);
      const filtered = users.filter(u=>!existing.includes(u.id));
      const results = document.getElementById('ri-add-results'); results.innerHTML = '';
      filtered.forEach(u => {
        const el = document.createElement('div'); el.className = 'member-entry'; el.style.cursor = 'pointer';
        el.innerHTML = `<img src="${u.avatar_url||'/default.png'}"><div class="member-entry-info"><div class="member-entry-name">${esc(u.display_name||u.username)}</div></div><div style="color:var(--accent);font-size:.8rem">+ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ</div>`;
        el.onclick = () => addMemberToRoom(u.id); results.appendChild(el);
      });
    }
    async function addMemberToRoom(userId) {
      try { const r = await fetch(`/api/rooms/${ROOM}/add-member`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId}) }); const d = await r.json(); if (d.success) { toast('Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½', 'success'); openRoomInfo(); } } catch(e) {}
    }
    async function leaveRoom() {
      if (!confirm('ĞŸĞ¾ĞºĞ¸Ğ½ÑƒÑ‚ÑŒ?')) return;
      await fetch(`/api/rooms/${ROOM}/leave`, { method:'POST' });
      closeRoomInfo(); ROOM = null; CONTACT = null;
      document.getElementById('active-chat').classList.remove('show');
      document.getElementById('no-chat').classList.remove('hidden');
      loadContacts();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CALLS (WebRTC)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let localStream = null;
    let peerConnection = null;
    let incomingCallOffer = null;
    let activeCallerId = null;

    const rtcConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    };

    function startCallFromChat() {
      if (CONTACT) startCall(CONTACT);
      else toast('Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚', 'error');
    }
    function startVideoCallFromChat() {
      if (CONTACT) startCall(CONTACT);
      else toast('Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚', 'error');
    }

    async function startCall(targetUserId) {
      if (!targetUserId) return;
      activeCallerId = targetUserId;
      document.getElementById('activeCallModal').classList.add('show');
      await setupMedia();
      peerConnection = new RTCPeerConnection(rtcConfig);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      peerConnection.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };
      peerConnection.onicecandidate = e => {
        if (e.candidate) ws.send(JSON.stringify({ type:'ice_candidate', toUserId:targetUserId, candidate:e.candidate }));
      };
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      ws.send(JSON.stringify({ type:'call_user', toUserId:targetUserId, offer }));
    }

    function handleIncomingCall(msg) {
      incomingCallOffer = msg.offer;
      activeCallerId = msg.socket;
      const audio = document.getElementById('callSound');
      if (audio) audio.play().catch(() => {});
      document.getElementById('incomingCallModal').classList.add('show');
    }

    async function acceptCall() {
      document.getElementById('callSound').pause();
      document.getElementById('incomingCallModal').classList.remove('show');
      document.getElementById('activeCallModal').classList.add('show');
      await setupMedia();
      peerConnection = new RTCPeerConnection(rtcConfig);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      peerConnection.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };
      peerConnection.onicecandidate = e => {
        if (e.candidate) ws.send(JSON.stringify({ type:'ice_candidate', toUserId:activeCallerId, candidate:e.candidate }));
      };
      await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingCallOffer));
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      ws.send(JSON.stringify({ type:'make_answer', toUserId:activeCallerId, answer }));
    }

    function rejectCall() {
      document.getElementById('callSound').pause();
      document.getElementById('incomingCallModal').classList.remove('show');
      ws.send(JSON.stringify({ type:'reject_call', toUserId:activeCallerId }));
    }

    function endCall() {
      document.getElementById('activeCallModal').classList.remove('show');
      document.getElementById('incomingCallModal').classList.remove('show');
      document.getElementById('callSound').pause();
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      if (peerConnection) peerConnection.close();
      peerConnection = null; localStream = null;
    }

    async function setupMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
      } catch(e) { toast('ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ĞºĞ°Ğ¼ĞµÑ€Ğµ!', 'error'); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  KEYBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeProfile(); closeCreate(); closeUserProfile(); closeRoomInfo();
        document.getElementById('img-viewer').classList.add('hidden');
        endCall();
      }
    });

    document.getElementById('code-input')?.addEventListener('input', function() {
      this.value = this.value.replace(/\D/g, '');
      if (this.value.length === 6) login();
    });

    document.getElementById('email-input')?.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') sendCode();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    checkAuth();
    console.log('ğŸš€ EchoVoid Ready');
  </script>
</body>
</html>